name: Atom Sayfa KaynaÄŸÄ±nÄ± Otomatik Al

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */3 * * *'
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: write
  actions: read
  checks: write

jobs:
  sayfa-kaydet:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: ðŸ“¥ Repoyu Klonla
      uses: actions/checkout@v3
      with:
        fetch-depth: 1
    
    - name: ðŸ“… Tarih Bilgisi
      id: date
      run: |
        echo "TR_SAAT=$(TZ='Europe/Istanbul' date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV
        echo "UTC_SAAT=$(date -u '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV
    
    - name: ðŸ Python Kur
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'  # ÅžÄ°MDÄ° Ã‡ALIÅžIR (requirements.txt var)
    
    - name: ðŸ“¦ Paketleri YÃ¼kle
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt  # requirements.txt'den yÃ¼kle
    
    - name: ðŸš€ BetiÄŸi Ã‡alÄ±ÅŸtÄ±r
      id: run_script
      run: |
        echo "ðŸ•’ BaÅŸlangÄ±Ã§: ${{ env.TR_SAAT }} (TR)"
        python atom.py 2>&1 | tee script_output.txt
        
        if [ ${PIPESTATUS[0]} -eq 0 ]; then
          echo "âœ… Betik baÅŸarÄ±lÄ±" >> $GITHUB_STEP_SUMMARY
          echo "status=success" >> $GITHUB_OUTPUT
        else
          echo "âŒ Betik baÅŸarÄ±sÄ±z" >> $GITHUB_STEP_SUMMARY
          echo "status=failed" >> $GITHUB_OUTPUT
        fi
      continue-on-error: true
    
    - name: ðŸ“‚ DosyalarÄ± Kontrol Et
      run: |
        echo "## ðŸ“ Dizin iÃ§eriÄŸi" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        ls -la >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        
        if [ -f "atom.txt" ]; then
          DOSYA_BOYUT=$(wc -c < atom.txt)
          SATIR_SAYISI=$(wc -l < atom.txt)
          echo "âœ… **atom.txt bulundu**" >> $GITHUB_STEP_SUMMARY
          echo "- **Boyut:** $DOSYA_BOYUT bytes" >> $GITHUB_STEP_SUMMARY
          echo "- **SatÄ±r:** $SATIR_SAYISI satÄ±r" >> $GITHUB_STEP_SUMMARY
          
          # Ä°lk 5 satÄ±rÄ± gÃ¶ster
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“„ Ä°lk 5 satÄ±r:" >> $GITHUB_STEP_SUMMARY
          echo '```html' >> $GITHUB_STEP_SUMMARY
          head -5 atom.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **atom.txt bulunamadÄ±!**" >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: ðŸ’¾ DeÄŸiÅŸiklikleri Kaydet
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        git add atom.txt script_output.txt 2>/dev/null || true
        
        if [ -f "README.md" ]; then
          sed -i '/## ðŸ“Š Son Durum/d' README.md 2>/dev/null || true
          echo "" >> README.md
          echo "## ðŸ“Š Son Durum" >> README.md
          echo "- **Tarih:** ${{ env.TR_SAAT }}" >> README.md
          echo "- **Durum:** ${{ steps.run_script.outputs.status }}" >> README.md
          if [ -f "atom.txt" ]; then
            echo "- **Dosya:** atom.txt ($(wc -c < atom.txt) bytes)" >> README.md
          fi
          git add README.md
        fi
        
        git commit -m "ðŸ¤– Otomatik gÃ¼ncelleme: ${{ env.TR_SAAT }}" || echo "DeÄŸiÅŸiklik yok"
    
    - name: ðŸ“¤ GitHub'a GÃ¶nder
      uses: ad-m/github-push-action@v0.8.0
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: ${{ github.ref }}
        force: false
