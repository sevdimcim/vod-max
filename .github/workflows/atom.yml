name: Atom Sayfa Kaynaƒüƒ±nƒ± Otomatik Al

# √áalƒ±≈üma zamanlarƒ±
on:
  # Elle √ßalƒ±≈ütƒ±rma butonu
  workflow_dispatch:
    inputs:
      manuel_calistir:
        description: 'Manuel √ßalƒ±≈ütƒ±rma'
        required: false
        default: 'true'
  
  # Otomatik zamanlama (her 3 saatte bir)
  schedule:
    - cron: '0 */3 * * *'  # Her 3 saatte bir (T√ºrkiye saatiyle 03:00, 06:00, ...)
    
  # Push yapƒ±ldƒ±ƒüƒ±nda
  push:
    branches: [ main, master ]
    paths:
      - 'atom.py'
      - '.github/workflows/atom_otomatik.yml'
  
  # Pull request a√ßƒ±ldƒ±ƒüƒ±nda
  pull_request:
    branches: [ main, master ]

# ƒ∞zinler
permissions:
  contents: write
  actions: read
  checks: write

# ƒ∞≈ü tanƒ±mƒ±
jobs:
  sayfa-kaydet:
    runs-on: ubuntu-latest
    timeout-minutes: 10  # Maksimum 10 dakika √ßalƒ±≈üsƒ±n
    
    steps:
    # 1. Repoyu klonla
    - name: üì• Repoyu Klonla
      uses: actions/checkout@v3
      with:
        fetch-depth: 1  # Sadece son commit
    
    # 2. Tarih ve saat bilgisi
    - name: üìÖ Tarih Bilgisi
      id: date
      run: |
        echo "TR_SAAT=$(TZ='Europe/Istanbul' date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV
        echo "UTC_SAAT=$(date -u '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV
    
    # 3. Python kur
    - name: üêç Python Kur
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'  # Son kararlƒ± s√ºr√ºm
        cache: 'pip'  # Pip cache'i kullan
    
    # 4. Gerekli paketleri y√ºkle
    - name: üì¶ Paketleri Y√ºkle
      run: |
        python -m pip install --upgrade pip
        pip install requests brotli zlib
    
    # 5. Betiƒüi √ßalƒ±≈ütƒ±r
    - name: üöÄ Betiƒüi √áalƒ±≈ütƒ±r
      id: run_script
      run: |
        echo "üïí Ba≈ülangƒ±√ß: ${{ env.TR_SAAT }} (TR)"
        echo "üïí Ba≈ülangƒ±√ß: ${{ env.UTC_SAAT }} (UTC)"
        echo ""
        
        # Betiƒüi √ßalƒ±≈ütƒ±r ve √ßƒ±ktƒ±yƒ± logla
        python atom.py 2>&1 | tee script_output.txt
        
        # √áalƒ±≈üma durumunu kontrol et
        if [ ${PIPESTATUS[0]} -eq 0 ]; then
          echo "‚úÖ Betik ba≈üarƒ±lƒ±" >> $GITHUB_STEP_SUMMARY
          echo "status=success" >> $GITHUB_OUTPUT
        else
          echo "‚ùå Betik ba≈üarƒ±sƒ±z" >> $GITHUB_STEP_SUMMARY
          echo "status=failed" >> $GITHUB_OUTPUT
        fi
      continue-on-error: true  # Hata olsa bile devam et
    
    # 6. Dosyalarƒ± kontrol et
    - name: üìÇ Dosyalarƒ± Kontrol Et
      run: |
        echo "## üìÅ Dizin i√ßeriƒüi" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        ls -la >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # atom.txt kontrol√º
        if [ -f "atom.txt" ]; then
          DOSYA_BOYUT=$(wc -c < atom.txt)
          SATIR_SAYISI=$(wc -l < atom.txt)
          echo "‚úÖ **atom.txt bulundu**" >> $GITHUB_STEP_SUMMARY
          echo "- **Boyut:** $DOSYA_BOYUT bytes" >> $GITHUB_STEP_SUMMARY
          echo "- **Satƒ±r:** $SATIR_SAYISI satƒ±r" >> $GITHUB_STEP_SUMMARY
          
          # ƒ∞lk 10 satƒ±r
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìÑ ƒ∞lk 10 satƒ±r:" >> $GITHUB_STEP_SUMMARY
          echo '```html' >> $GITHUB_STEP_SUMMARY
          head -10 atom.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        else
          echo "‚ùå **atom.txt bulunamadƒ±!**" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Binary dosya kontrol√º
        if [ -f "atom_binary.bin" ]; then
          BIN_BOYUT=$(wc -c < atom_binary.bin)
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üìÅ **Binary dosya bulundu:** atom_binary.bin" >> $GITHUB_STEP_SUMMARY
          echo "- **Boyut:** $BIN_BOYUT bytes" >> $GITHUB_STEP_SUMMARY
        fi
    
    # 7. Deƒüi≈üiklikleri commit et
    - name: üíæ Deƒüi≈üiklikleri Kaydet
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        # Deƒüi≈üen dosyalarƒ± ekle
        git add atom.txt atom_binary.bin script_output.txt 2>/dev/null || true
        
        # README varsa g√ºncelle
        if [ -f "README.md" ]; then
          # README'ye sonu√ß ekle
          sed -i '/## üìä Son Durum/d' README.md 2>/dev/null || true
          echo "" >> README.md
          echo "## üìä Son Durum" >> README.md
          echo "- **Tarih:** ${{ env.TR_SAAT }}" >> README.md
          echo "- **Durum:** ${{ steps.run_script.outputs.status }}" >> README.md
          if [ -f "atom.txt" ]; then
            echo "- **Dosya:** atom.txt ($(wc -c < atom.txt) bytes)" >> README.md
          fi
          git add README.md
        fi
        
        # Commit olu≈ütur
        git commit -m "ü§ñ Otomatik g√ºncelleme: ${{ env.TR_SAAT }}" || echo "Deƒüi≈üiklik yok"
        
    # 8. GitHub'a g√∂nder
    - name: üì§ GitHub'a G√∂nder
      uses: ad-m/github-push-action@v0.8.0
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: ${{ github.ref }}
        force: false  # Force push yapma
    
    # 9. ƒ∞statistikleri g√∂ster
    - name: üìä ƒ∞statistikler
      run: |
        echo "## üìä ƒ∞≈ülem ƒ∞statistikleri" >> $GITHUB_STEP_SUMMARY
        echo "- **Ba≈ülangƒ±√ß:** ${{ env.TR_SAAT }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Biti≈ü:** $(TZ='Europe/Istanbul' date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
        echo "- **Workflow:** ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Repo:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Run ID:** ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
        
    # 10. Hata varsa bildirim (opsiyonel)
    - name: ‚ö†Ô∏è Hata Bildirimi
      if: steps.run_script.outputs.status == 'failed'
      run: |
        echo "## ‚ö†Ô∏è Hata Olu≈ütu" >> $GITHUB_STEP_SUMMARY
        echo "Betik √ßalƒ±≈üƒ±rken hata olu≈ütu. Loglarƒ± kontrol edin." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        cat script_output.txt >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
