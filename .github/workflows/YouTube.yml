name: Update YouTube Live M3U8 Playlists

on:
  # Manuel Ã§alÄ±ÅŸtÄ±rma iÃ§in (GitHub UI'dan)
  workflow_dispatch:
    inputs:
      channel_url:
        description: 'YouTube Channel URL (optional)'
        required: false
        default: ''
  
  # Her gÃ¼n otomatik Ã§alÄ±ÅŸtÄ±r
  schedule:
    - cron: '0 */6 * * *'  # 6 saatte bir (gÃ¼nde 4 kez)
  
  # Kod deÄŸiÅŸtiÄŸinde Ã§alÄ±ÅŸtÄ±r
  push:
    branches: [ main, master ]
    paths:
      - 'YouTube.py'
      - 'channels.txt'
      - '.github/workflows/update-m3u8.yml'

jobs:
  update-playlists:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install yt-dlp
        pip install requests
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
    
    - name: Create necessary directories
      run: |
        mkdir -p playlists
        mkdir -p logs
    
    - name: Run YouTube M3U8 Generator
      env:
        CHANNEL_URL: ${{ github.event.inputs.channel_url }}
      run: |
        echo "=== YouTube M3U8 Generator ==="
        echo "Start time: $(date)"
        
        # Kanal listesi dosyasÄ±nÄ± kontrol et
        if [ -f channels.txt ]; then
          echo "Processing channels from channels.txt..."
          python YouTube.py --batch channels.txt
        elif [ ! -z "$CHANNEL_URL" ]; then
          echo "Processing single channel: $CHANNEL_URL"
          python YouTube.py --url "$CHANNEL_URL"
        else
          echo "No channel specified, running in interactive mode..."
          echo -e "1\nhttps://www.youtube.com/live/na_jT2Q1rfA" | python YouTube.py
        fi
        
        echo "End time: $(date)"
        echo "=== Process Complete ==="
    
    - name: List generated files
      run: |
        echo "Generated M3U8 files:"
        ls -la playlists/ || echo "No playlists directory"
        echo "Log files:"
        ls -la logs/ || echo "No logs directory"
    
    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # DeÄŸiÅŸiklikleri kontrol et
        git add playlists/ logs/ || echo "No new files to add"
        
        # DeÄŸiÅŸiklik varsa commit yap
        if git diff --cached --quiet; then
          echo "No changes to commit"
        else
          git commit -m "ðŸ“º Auto-update M3U8 playlists $(date '+%Y-%m-%d %H:%M:%S')"
          git push origin HEAD:${{ github.ref }}
        fi
    
    - name: Upload M3U8 files as artifact
      uses: actions/upload-artifact@v3
      with:
        name: m3u8-playlists
        path: playlists/
        if-no-files-found: warn
    
    - name: Upload logs
      uses: actions/upload-artifact@v3
      with:
        name: generation-logs
        path: logs/
        if-no-files-found: ignore
