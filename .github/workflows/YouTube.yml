name: YouTube M3U8 Playlist Generator

on:
  workflow_dispatch:
    inputs:
      channel_url:
        description: 'YouTube Live URL'
        required: false
        default: 'https://www.youtube.com/live/na_jT2Q1rfA'
      channel_name:
        description: 'Channel Name'
        required: false
        default: 'HalkTV'
  
  schedule:
    - cron: '0 */3 * * *'  # 3 saatte bir
  
  push:
    branches: [ main ]
    paths:
      - 'YouTube.py'
      - 'channels.txt'

jobs:
  generate-m3u8:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install yt-dlp
      run: pip install yt-dlp
    
    - name: Create directories
      run: |
        mkdir -p playlists
        mkdir -p logs
    
    - name: Run YouTube M3U8 Script
      id: run-script
      run: |
        echo "ðŸ” Starting M3U8 generation..."
        
        CHANNEL_URL="${{ github.event.inputs.channel_url }}"
        CHANNEL_NAME="${{ github.event.inputs.channel_name }}"
        
        if [ -f "channels.txt" ] && [ -s "channels.txt" ]; then
          echo "ðŸ“‹ Using channels.txt file"
          python YouTube.py --batch channels.txt
        elif [ ! -z "$CHANNEL_URL" ]; then
          echo "ðŸŽ¬ Processing: $CHANNEL_NAME ($CHANNEL_URL)"
          python YouTube.py --url "$CHANNEL_URL" --name "$CHANNEL_NAME"
        else
          echo "âš ï¸ No input provided, running default test"
          python YouTube.py --url "https://www.youtube.com/live/na_jT2Q1rfA" --name "HalkTV_Test"
        fi
        
        # Count generated files
        FILE_COUNT=$(find playlists -name "*.m3u8" -type f 2>/dev/null | wc -l)
        echo "FILE_COUNT=$FILE_COUNT" >> $GITHUB_OUTPUT
        echo "âœ… Found $FILE_COUNT M3U8 files"
    
    - name: Upload M3U8 Playlists
      uses: actions/upload-artifact@v4
      with:
        name: youtube-m3u8-playlists
        path: playlists/
        retention-days: 7
    
    - name: Upload Logs
      uses: actions/upload-artifact@v4
      with:
        name: generation-logs
        path: logs/
        retention-days: 3
    
    - name: Commit M3U8 Files
      if: steps.run-script.outputs.FILE_COUNT != '0'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        git add playlists/
        
        if git diff --cached --quiet; then
          echo "ðŸ“Œ No new M3U8 files to commit"
        else
          git commit -m "ðŸ¤– Auto-update M3U8 playlists $(date '+%Y-%m-%d %H:%M')"
          git push
        fi
